<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–°—á—ë—Ç—á–∏–∫ –∫–∞–ª–æ—Ä–∏–π</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    }

    body[data-theme="light"] {
      --tg-theme-bg-color: #ffffff;
      --tg-theme-text-color: #000000;
      --tg-theme-secondary-bg-color: #f2f2f7;
      --tg-theme-hint-color: #8e8e93;
      --tg-theme-button-color: #007aff;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-destructive-text-color: #ff3b30;
    }

    body[data-theme="dark"] {
      --tg-theme-bg-color: #0c0c0e;
      --tg-theme-text-color: #ffffff;
      --tg-theme-secondary-bg-color: #1c1c1e;
      --tg-theme-hint-color: #8e8e93;
      --tg-theme-button-color: #0a84ff;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-destructive-text-color: #ff453a;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-theme-bg-color, #18222d);
      color: var(--tg-theme-text-color, #ffffff);
      min-height: 100vh;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
    }

    .hero-header {
      text-align: center;
      margin-bottom: 8px;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    }

    .hero-greeting {
      font-size: 26px;
      font-weight: 700;
      color: var(--tg-theme-text-color, #ffffff);
      margin-bottom: 6px;
      letter-spacing: -0.5px;
    }

    .hero-subtitle {
      font-size: 14px;
      font-weight: 500;
      color: var(--tg-theme-hint-color, #8e8e93);
      letter-spacing: 0.2px;
    }

    .form {
      background: var(--tg-theme-secondary-bg-color, #242f3d);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
    }

    .input-group {
      margin-bottom: 12px;
      position: relative;
    }

    .input-group:last-of-type {
      margin-bottom: 16px;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      background: var(--tg-theme-secondary-bg-color, #242f3d);
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
    }

    .autocomplete-item {
      padding: 12px 16px;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px;
      margin: 4px;
      color: var(--tg-theme-text-color, #ffffff);
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
      background: var(--tg-theme-bg-color, #18222d);
    }

    .autocomplete-item .cal {
      font-size: 13px;
      color: var(--tg-theme-button-color, #2aabee);
      font-weight: 600;
    }

    label {
      display: block;
      font-size: 14px;
      color: var(--tg-theme-hint-color, #8e8e93);
      margin-bottom: 6px;
    }

    input {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      background: var(--tg-theme-bg-color, #18222d);
      color: var(--tg-theme-text-color, #ffffff);
    }

    input::placeholder {
      color: var(--tg-theme-hint-color, #8e8e93);
    }

    input:focus {
      outline: none;
    }

    .btn-add {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 16px;
      background: var(--tg-theme-button-color, #2aabee);
      color: var(--tg-theme-button-text-color, #ffffff);
      cursor: pointer;
      transition: transform 0.15s ease, opacity 0.2s;
    }

    .btn-add:active {
      transform: scale(0.97);
      opacity: 0.9;
    }

    .hero-block {
      text-align: center;
      margin-bottom: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    }

    .hero-calories {
      font-size: 52px;
      font-weight: 800;
      color: var(--tg-theme-text-color, #ffffff);
      line-height: 1.1;
      letter-spacing: -1.5px;
    }

    .hero-remaining {
      font-size: 13px;
      color: var(--tg-theme-hint-color, #8e8e93);
      margin-top: 6px;
    }

    .bju-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 12px;
      font-size: 12px;
      color: var(--tg-theme-hint-color, #8e8e93);
    }

    .bju-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .bju-item span:first-child {
      color: var(--tg-theme-text-color, #ffffff);
      font-weight: 600;
    }

    .list-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--tg-theme-text-color, #ffffff);
    }

    .food-list {
      list-style: none;
    }

    .food-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--tg-theme-secondary-bg-color, #242f3d);
      border-radius: 16px;
      padding: 10px 14px;
      margin-bottom: 6px;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      animation: foodItemFadeIn 0.35s ease-out forwards;
    }

    @keyframes foodItemFadeIn {
      from {
        opacity: 0;
        transform: translateY(-4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .food-name {
      font-weight: 500;
      color: var(--tg-theme-text-color, #ffffff);
    }

    .food-item-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .food-calories {
      font-weight: 600;
      color: var(--tg-theme-button-color, #2aabee);
      font-size: 13px;
    }

    .empty-state {
      text-align: center;
      padding: 32px 20px;
      color: var(--tg-theme-hint-color, #8e8e93);
      font-size: 14px;
    }

    .btn-delete {
      background: transparent;
      border: none;
      color: var(--tg-theme-hint-color, #8e8e93);
      font-size: 16px;
      cursor: pointer;
      padding: 4px;
      opacity: 0.8;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      min-height: 32px;
      border-radius: 8px;
    }

    .btn-delete:hover,
    .btn-delete:active {
      opacity: 1;
      color: var(--tg-theme-destructive-text-color, #ff6b6b);
      background: rgba(255, 107, 107, 0.15);
    }

    .btn-history,
    .btn-today-list {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid var(--tg-theme-button-color, #2aabee);
      border-radius: 16px;
      background: transparent;
      color: var(--tg-theme-button-color, #2aabee);
      cursor: pointer;
      margin-bottom: 10px;
      transition: opacity 0.2s;
    }

    .btn-history:hover,
    .btn-history:active,
    .btn-today-list:hover,
    .btn-today-list:active {
      opacity: 0.9;
      background: rgba(42, 171, 238, 0.1);
    }

    .btn-today-list {
      margin-bottom: 10px;
    }

    .btn-settings-goal {
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 500;
      border: 1px solid var(--tg-theme-hint-color, rgba(142, 142, 147, 0.5));
      border-radius: 16px;
      background: transparent;
      color: var(--tg-theme-hint-color, #8e8e93);
      cursor: pointer;
      margin-bottom: 20px;
      transition: opacity 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-settings-goal:hover,
    .btn-settings-goal:active {
      opacity: 0.85;
      background: rgba(142, 142, 147, 0.08);
    }

    .footer-theme {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      margin-top: 8px;
      margin-bottom: 20px;
      padding: 8px 0;
    }

    .btn-theme {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      opacity: 0.5;
      filter: grayscale(1);
      transition: opacity 0.2s ease, filter 0.2s ease;
    }

    .btn-theme:hover,
    .btn-theme:active {
      opacity: 0.8;
    }

    .btn-theme.active {
      opacity: 1;
      filter: grayscale(0);
    }

    .btn-theme.active::after {
      content: '';
      display: block;
      width: 4px;
      height: 4px;
      background: var(--tg-theme-button-color, #2aabee);
      border-radius: 50%;
      margin: 2px auto 0;
    }

    .history-modal .modal {
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .history-list {
      overflow-y: auto;
      max-height: 50vh;
      margin-top: 8px;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      font-size: 14px;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-date {
      color: var(--tg-theme-text-color, #ffffff);
      font-weight: 500;
    }

    .history-cal {
      color: var(--tg-theme-button-color, #2aabee);
      font-weight: 600;
      margin-right: 12px;
    }

    .history-status {
      font-size: 18px;
    }

    .history-status.ok {
      color: var(--tg-theme-button-color, #2aabee);
    }

    .history-status.fail {
      color: var(--tg-theme-destructive-text-color, #ff6b6b);
    }

    /* Drawer —Å–ø–∏—Å–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è */
    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.25s ease, visibility 0.25s ease;
    }

    .drawer-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--tg-theme-secondary-bg-color, #242f3d);
      border-radius: 20px 20px 0 0;
      max-height: 75vh;
      z-index: 1001;
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
      padding: 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
      box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.3);
    }

    .drawer-overlay.open .drawer {
      transform: translateY(0);
    }

    .drawer-handle {
      width: 36px;
      height: 4px;
      background: var(--tg-theme-hint-color, #8e8e93);
      border-radius: 2px;
      margin: 0 auto 16px;
      opacity: 0.5;
    }

    .drawer-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--tg-theme-text-color, #ffffff);
      margin-bottom: 16px;
      text-align: center;
    }

    .drawer-list {
      overflow-y: auto;
      max-height: calc(75vh - 80px);
    }

    .drawer-empty {
      text-align: center;
      padding: 48px 20px;
      color: var(--tg-theme-hint-color, #8e8e93);
      font-size: 15px;
    }

    .drawer-actions {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .btn-clear-list {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid var(--tg-theme-destructive-text-color, #ff6b6b);
      border-radius: 12px;
      background: transparent;
      color: var(--tg-theme-destructive-text-color, #ff6b6b);
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn-clear-list:hover,
    .btn-clear-list:active {
      opacity: 0.9;
      background: rgba(255, 107, 107, 0.1);
    }

    .confirm-modal {
      z-index: 1100;
    }

    .confirm-modal .modal {
      max-width: 300px;
    }

    .confirm-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .confirm-buttons button {
      flex: 1;
      padding: 12px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .confirm-buttons .btn-cancel {
      background: var(--tg-theme-bg-color, #18222d);
      color: var(--tg-theme-text-color, #ffffff);
    }

    .confirm-buttons .btn-confirm {
      background: var(--tg-theme-destructive-text-color, #ff6b6b);
      color: #fff;
    }

    .confirm-buttons button:active {
      opacity: 0.8;
    }

    /* –ú–æ–¥–∞–ª–∫–∞ —Ü–µ–ª–∏ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal {
      background: var(--tg-theme-secondary-bg-color, #242f3d);
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 340px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--tg-theme-text-color, #ffffff);
      margin-bottom: 8px;
      text-align: center;
    }

    .modal-subtitle {
      font-size: 14px;
      color: var(--tg-theme-hint-color, #8e8e93);
      margin-bottom: 20px;
      text-align: center;
    }

    .modal .input-group {
      margin-bottom: 20px;
    }

    .modal .btn-add {
      margin-top: 4px;
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
    .progress-section {
      background: var(--tg-theme-secondary-bg-color, #242f3d);
      border-radius: 16px;
      padding: 14px;
      margin-bottom: 20px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
    }

    .progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .progress-label {
      font-size: 13px;
      color: var(--tg-theme-hint-color, #8e8e93);
    }

    .progress-goal {
      font-size: 13px;
      color: var(--tg-theme-text-color, #ffffff);
    }

    .progress-bar-wrap {
      height: 8px;
      background: var(--tg-theme-bg-color, #18222d);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 4px;
      background: var(--tg-theme-button-color, #2aabee);
      transition: width 0.5s ease-in-out, background 0.2s ease;
    }

    .progress-bar-fill.over-limit {
      background: var(--tg-theme-destructive-text-color, #ff6b6b);
    }
  </style>
</head>
<body>
  <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–µ—Ä–≤–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–µ–ª–∏ -->
  <div class="modal-overlay" id="goalModal" style="display: none;">
    <div class="modal">
      <div class="modal-title">üéØ –í–∞—à–∞ —Ü–µ–ª—å</div>
      <div class="modal-subtitle">–°–∫–æ–ª—å–∫–æ –∫–∞–ª–æ—Ä–∏–π –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —Å—ä–µ–¥–∞—Ç—å –≤ –¥–µ–Ω—å?</div>
      <form id="goalForm">
        <div class="input-group">
          <label for="goalInput">–¶–µ–ª—å (–∫–∫–∞–ª –≤ –¥–µ–Ω—å)</label>
          <input type="number" id="goalInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2000" min="500" max="10000" step="50" required>
        </div>
        <button type="submit" class="btn-add">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </form>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
  <div class="modal-overlay history-modal" id="historyModal" style="display: none;">
    <div class="modal">
      <div class="modal-title">üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞ 7 –¥–Ω–µ–π</div>
      <div class="modal-subtitle">–°—É–º–º–∞ –∫–∞–ª–æ—Ä–∏–π –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–ª–∏</div>
      <div class="history-list" id="historyList"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—á–∏—Å—Ç–∫–∏ -->
  <div class="modal-overlay confirm-modal" id="confirmClearModal" style="display: none;">
    <div class="modal">
      <div class="modal-title">–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫?</div>
      <div class="modal-subtitle">–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</div>
      <div class="confirm-buttons">
        <button type="button" class="btn-cancel" id="confirmClearCancel">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn-confirm" id="confirmClearOk">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Drawer —Å–ø–∏—Å–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è -->
  <div class="drawer-overlay" id="todayListOverlay">
    <div class="drawer">
      <div class="drawer-handle"></div>
      <div class="drawer-title">–ú–æ–π —Å–ø–∏—Å–æ–∫ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
      <div class="drawer-list" id="todayListContent"></div>
      <div class="drawer-actions" id="drawerActions" style="display: none;">
        <button type="button" class="btn-clear-list" id="btnClearList">–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Å–ø–∏—Å–æ–∫</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –≥–ª–∞–≤–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å -->
    <div class="hero-header">
      <div class="hero-greeting" id="heroGreeting">–î–æ–±—Ä—ã–π –¥–µ–Ω—å!</div>
      <div class="hero-subtitle" id="heroSubtitle">–°–µ–≥–æ–¥–Ω—è –≤—ã —É–ø–æ—Ç—Ä–µ–±–∏–ª–∏:</div>
    </div>
    <div class="hero-block">
      <div class="hero-calories" id="heroCalories">0</div>
      <div class="hero-remaining" id="heroRemaining">–æ—Å—Ç–∞–ª–æ—Å—å: ‚Äî –∫–∫–∞–ª</div>
      <div class="bju-row" id="bjuRow">
        <span class="bju-item">–ë <span id="bjuProtein">0</span>–≥</span>
        <span class="bju-item">–ñ <span id="bjuFat">0</span>–≥</span>
        <span class="bju-item">–£ <span id="bjuCarbs">0</span>–≥</span>
      </div>
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Ü–µ–ª–∏ -->
    <div class="progress-section" id="progressSection" style="display: none;">
      <div class="progress-header">
        <span class="progress-label" id="progressLabel">0 / 0 –∫–∫–∞–ª</span>
        <span class="progress-goal">–¶–µ–ª—å: <span id="goalValue">0</span> –∫–∫–∞–ª</span>
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;"></div>
      </div>
    </div>

    <form class="form" id="foodForm">
      <div class="input-group" id="foodNameGroup">
        <label for="foodName">–ù–∞–∑–≤–∞–Ω–∏–µ –µ–¥—ã</label>
        <input type="text" id="foodName" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å ‚Äî –ø–æ—è–≤—è—Ç—Å—è –ø–æ–¥—Å–∫–∞–∑–∫–∏" autocomplete="off">
        <div class="autocomplete-dropdown" id="autocompleteDropdown" style="display: none;"></div>
      </div>
      <div class="input-group">
        <label for="foodCalories">–ö–∞–ª–æ—Ä–∏–∏</label>
        <input type="number" id="foodCalories" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 350" min="0" step="1" required>
      </div>
      <button type="submit" class="btn-add">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>

    <button type="button" class="btn-history" id="btnHistory">–ò—Å—Ç–æ—Ä–∏—è –∑–∞ 7 –¥–Ω–µ–π</button>
    <button type="button" class="btn-today-list" id="btnTodayList">–ú–æ–π —Å–ø–∏—Å–æ–∫ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</button>
    <button type="button" class="btn-settings-goal" id="btnSettingsGoal" aria-label="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ü–µ–ª—å">‚öô –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ü–µ–ª—å</button>
    <div class="footer-theme">
      <button type="button" class="btn-theme" id="btnThemeLight" aria-label="–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞">‚òÄÔ∏è</button>
      <button type="button" class="btn-theme active" id="btnThemeDark" aria-label="–¢—ë–º–Ω–∞—è —Ç–µ–º–∞">üåô</button>
    </div>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
    }

    const THEME_STORAGE_KEY = 'calorie_app_theme';

    function getStoredTheme() {
      return localStorage.getItem(THEME_STORAGE_KEY) || 'dark';
    }

    function setTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem(THEME_STORAGE_KEY, theme);
      document.getElementById('btnThemeLight').classList.toggle('active', theme === 'light');
      document.getElementById('btnThemeDark').classList.toggle('active', theme === 'dark');
    }

    setTheme(getStoredTheme());

    function getGreeting() {
      const h = new Date().getHours();
      if (h >= 5 && h < 12) return { text: '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!', emoji: '‚òÄÔ∏è' };
      if (h >= 12 && h < 17) return { text: '–î–æ–±—Ä—ã–π –¥–µ–Ω—å!', emoji: 'üå§' };
      if (h >= 17 && h < 22) return { text: '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!', emoji: 'üåÜ' };
      return { text: '–î–æ–±—Ä–æ–π –Ω–æ—á–∏!', emoji: 'üåô' };
    }

    function updateGreeting() {
      const g = getGreeting();
      document.getElementById('heroGreeting').textContent = g.emoji + ' ' + g.text;
    }

    updateGreeting();

    const FOOD_STORAGE_KEY = 'calorie_app_foods';
    const GOAL_STORAGE_KEY = 'calorie_app_goal';

    function getGoal() {
      const v = localStorage.getItem(GOAL_STORAGE_KEY);
      return v ? parseInt(v, 10) : null;
    }

    function setGoal(value) {
      localStorage.setItem(GOAL_STORAGE_KEY, String(value));
    }

    function showGoalModal() {
      document.getElementById('goalModal').style.display = 'flex';
    }

    function hideGoalModal() {
      document.getElementById('goalModal').style.display = 'none';
    }

    function updateProgress(total, goal) {
      const section = document.getElementById('progressSection');
      const label = document.getElementById('progressLabel');
      const goalValue = document.getElementById('goalValue');
      const fill = document.getElementById('progressBarFill');

      if (!goal || goal <= 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      label.textContent = total + ' / ' + goal + ' –∫–∫–∞–ª';
      goalValue.textContent = goal;

      const percent = Math.min((total / goal) * 100, 100);
      fill.style.width = percent + '%';
      fill.classList.toggle('over-limit', total > goal);

      if (total > goal) {
        fill.style.width = '100%';
      }
    }

    function updateHero(total, goal, bju) {
      document.getElementById('heroCalories').textContent = total;
      const rem = goal && goal > 0 ? Math.max(0, goal - total) : null;
      document.getElementById('heroRemaining').textContent = rem !== null
        ? '–æ—Å—Ç–∞–ª–æ—Å—å: ' + rem + ' –∫–∫–∞–ª'
        : '–æ—Å—Ç–∞–ª–æ—Å—å: ‚Äî –∫–∫–∞–ª';
      document.getElementById('bjuProtein').textContent = Math.round(bju.protein || 0);
      document.getElementById('bjuFat').textContent = Math.round(bju.fat || 0);
      document.getElementById('bjuCarbs').textContent = Math.round(bju.carbs || 0);
    }

    function estimateBJU(calories) {
      return {
        protein: Math.round(calories * 0.25 / 4),
        fat: Math.round(calories * 0.3 / 9),
        carbs: Math.round(calories * 0.45 / 4)
      };
    }

    function getBJUFromDb(name, calories) {
      const match = FOOD_DATABASE.find(f => f.name.toLowerCase() === name.trim().toLowerCase());
      if (match && match.protein != null) {
        const k = match.calories > 0 ? calories / match.calories : 1;
        return {
          protein: (match.protein || 0) * k,
          fat: (match.fat || 0) * k,
          carbs: (match.carbs || 0) * k
        };
      }
      return estimateBJU(calories);
    }

    const FOOD_DATABASE = [
      { name: '–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ', calories: 165, protein: 31, fat: 3.6, carbs: 0 },
      { name: '–Ø–±–ª–æ–∫–æ', calories: 52, protein: 0.3, fat: 0.2, carbs: 14 },
      { name: '–†–∏—Å', calories: 130, protein: 2.4, fat: 0.5, carbs: 28 },
      { name: '–†–∏—Å –æ—Ç–≤–∞—Ä–Ω–æ–π', calories: 116, protein: 2.2, fat: 0.5, carbs: 25 },
      { name: '–ë–∞–Ω–∞–Ω', calories: 89, protein: 1.1, fat: 0.3, carbs: 23 },
      { name: '–Ø–π—Ü–æ –≤–∞—Ä—ë–Ω–æ–µ', calories: 155, protein: 13, fat: 11, carbs: 1.1 },
      { name: '–Ø–π—Ü–æ', calories: 155, protein: 13, fat: 11, carbs: 1.1 },
      { name: '–û–≤—Å—è–Ω–∫–∞', calories: 68, protein: 2.4, fat: 1.4, carbs: 12 },
      { name: '–û–≤—Å—è–Ω–∞—è –∫–∞—à–∞', calories: 88, protein: 3.2, fat: 1.8, carbs: 15 },
      { name: '–ì—Ä–µ—á–∫–∞', calories: 132, protein: 4.2, fat: 1.3, carbs: 27 },
      { name: '–ì—Ä–µ—á–∫–∞ –æ—Ç–≤–∞—Ä–Ω–∞—è', calories: 101, protein: 3.2, fat: 1, carbs: 21 },
      { name: '–ú–æ–ª–æ–∫–æ', calories: 42, protein: 3.4, fat: 1, carbs: 4.8 },
      { name: '–ú–æ–ª–æ–∫–æ 2.5%', calories: 52, protein: 2.8, fat: 2.5, carbs: 4.7 },
      { name: '–ö–µ—Ñ–∏—Ä', calories: 50, protein: 2.8, fat: 1, carbs: 4 },
      { name: '–¢–≤–æ—Ä–æ–≥', calories: 101, protein: 18, fat: 0.6, carbs: 3.3 },
      { name: '–¢–≤–æ—Ä–æ–≥ 5%', calories: 121, protein: 17, fat: 5, carbs: 1.8 },
      { name: '–°—ã—Ä', calories: 402, protein: 25, fat: 33, carbs: 1.3 },
      { name: '–•–ª–µ–± –±–µ–ª—ã–π', calories: 265, protein: 8.9, fat: 3.2, carbs: 51 },
      { name: '–•–ª–µ–± —á—ë—Ä–Ω—ã–π', calories: 201, protein: 6.6, fat: 1.2, carbs: 40 },
      { name: '–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å', calories: 77, protein: 2, fat: 0.1, carbs: 17 },
      { name: '–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –∂–∞—Ä–µ–Ω—ã–π', calories: 192, protein: 2.5, fat: 9.5, carbs: 24 },
      { name: '–ú–∞–∫–∞—Ä–æ–Ω—ã', calories: 131, protein: 5, fat: 1.1, carbs: 25 },
      { name: '–ú–∞–∫–∞—Ä–æ–Ω—ã –æ—Ç–≤–∞—Ä–Ω—ã–µ', calories: 112, protein: 4.2, fat: 0.9, carbs: 22 },
      { name: '–õ–æ—Å–æ—Å—å', calories: 208, protein: 20, fat: 13, carbs: 0 },
      { name: '–ì–æ–≤—è–¥–∏–Ω–∞', calories: 250, protein: 26, fat: 15, carbs: 0 },
      { name: '–°–≤–∏–Ω–∏–Ω–∞', calories: 242, protein: 27, fat: 14, carbs: 0 },
      { name: '–ö–æ–ª–±–∞—Å–∞', calories: 301, protein: 12, fat: 28, carbs: 1 },
      { name: '–°–æ—Å–∏—Å–∫–∏', calories: 277, protein: 10, fat: 26, carbs: 1.5 },
      { name: '–ö–æ—Ç–ª–µ—Ç–∞', calories: 220, protein: 15, fat: 16, carbs: 6 },
      { name: '–°–∞–ª–∞—Ç –æ–≤–æ—â–Ω–æ–π', calories: 65, protein: 2, fat: 4, carbs: 5 },
      { name: '–û–≥—É—Ä–µ—Ü', calories: 15, protein: 0.7, fat: 0.1, carbs: 3.6 },
      { name: '–ü–æ–º–∏–¥–æ—Ä', calories: 18, protein: 0.9, fat: 0.2, carbs: 3.9 },
      { name: '–ú–æ—Ä–∫–æ–≤—å', calories: 41, protein: 0.9, fat: 0.2, carbs: 10 },
      { name: '–ë—Ä–æ–∫–∫–æ–ª–∏', calories: 34, protein: 2.8, fat: 0.4, carbs: 7 },
      { name: '–®–æ–∫–æ–ª–∞–¥ –º–æ–ª–æ—á–Ω—ã–π', calories: 535, protein: 8, fat: 30, carbs: 59 },
      { name: '–®–æ–∫–æ–ª–∞–¥ —Ç—ë–º–Ω—ã–π', calories: 546, protein: 5, fat: 31, carbs: 61 },
      { name: '–ü–µ—á–µ–Ω—å–µ', calories: 417, protein: 7.5, fat: 16, carbs: 63 },
      { name: '–ú—ë–¥', calories: 304, protein: 0, fat: 0, carbs: 82 },
      { name: '–°–∞—Ö–∞—Ä', calories: 398, protein: 0, fat: 0, carbs: 100 },
      { name: '–ô–æ–≥—É—Ä—Ç', calories: 66, protein: 5, fat: 1.5, carbs: 8 },
      { name: '–ö—É—Ä–∏—Ü–∞ –≤–∞—Ä—ë–Ω–∞—è', calories: 170, protein: 25, fat: 7, carbs: 0 },
      { name: '–ö–æ—Ñ–µ', calories: 2, protein: 0.2, fat: 0, carbs: 0 },
      { name: '–ß–∞–π', calories: 1, protein: 0, fat: 0, carbs: 0.3 },
      { name: '–°–æ–∫ –∞–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π', calories: 45, protein: 0.7, fat: 0.2, carbs: 10 },
      { name: '–í–æ–¥–∞', calories: 0, protein: 0, fat: 0, carbs: 0 },
      { name: '–ü–∏—Ü—Ü–∞', calories: 266, protein: 11, fat: 10, carbs: 33 },
      { name: '–ë—É—Ä–≥–µ—Ä', calories: 354, protein: 17, fat: 17, carbs: 31 },
      { name: '–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏', calories: 312, protein: 3.4, fat: 15, carbs: 41 },
      { name: '–û—Ä–µ—Ö–∏ –≥—Ä–µ—Ü–∫–∏–µ', calories: 654, protein: 15, fat: 65, carbs: 14 },
      { name: '–ú–∏–Ω–¥–∞–ª—å', calories: 579, protein: 21, fat: 50, carbs: 22 },
      { name: '–ê–≤–æ–∫–∞–¥–æ', calories: 160, protein: 2, fat: 15, carbs: 9 },
      { name: '–í–∏–Ω–æ–≥—Ä–∞–¥', calories: 69, protein: 0.7, fat: 0.2, carbs: 18 },
      { name: '–ê–ø–µ–ª—å—Å–∏–Ω', calories: 47, protein: 0.9, fat: 0.1, carbs: 12 },
      { name: '–ì—Ä—É—à–∞', calories: 57, protein: 0.4, fat: 0.1, carbs: 15 },
      { name: '–ö–ª—É–±–Ω–∏–∫–∞', calories: 32, protein: 0.7, fat: 0.3, carbs: 8 }
    ];

    function haptic(type, arg) {
      if (!tg?.HapticFeedback) return;
      if (type === 'impactOccurred') tg.HapticFeedback.impactOccurred(arg || 'light');
      else if (type === 'notificationOccurred') tg.HapticFeedback.notificationOccurred(arg || 'success');
      else if (type === 'selectionChanged') tg.HapticFeedback.selectionChanged();
      else tg.HapticFeedback[type]?.(arg);
    }

    const CONFETTI_STORAGE_KEY = 'calorie_app_confetti_date';

    function tryConfettiOnGoalReached(total, goal) {
      if (!goal || goal <= 0 || total < goal) return;
      const today = getTodayKey();
      if (localStorage.getItem(CONFETTI_STORAGE_KEY) === today) return;
      localStorage.setItem(CONFETTI_STORAGE_KEY, today);
      haptic('notificationOccurred', 'success');
      if (typeof confetti === 'function') {
        confetti({ particleCount: 80, spread: 70, origin: { y: 0.6 } });
      }
    }

    function getTodayKey() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    }

    function getDateKey(d) {
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    function getAllFoodsData() {
      try {
        return JSON.parse(localStorage.getItem(FOOD_STORAGE_KEY) || '{}');
      } catch {
        return {};
      }
    }

    function getFoods(dateKey) {
      const data = getAllFoodsData();
      return data[dateKey || getTodayKey()] || [];
    }

    function saveFoods(foods, dateKey) {
      const data = getAllFoodsData();
      data[dateKey || getTodayKey()] = foods;
      localStorage.setItem(FOOD_STORAGE_KEY, JSON.stringify(data));
    }

    function cleanupOldData() {
      const data = getAllFoodsData();
      const today = getTodayKey();
      const keepDays = 7;
      const keys = Object.keys(data);
      let changed = false;
      keys.forEach(k => {
        if (k === today) return;
        const keyDate = new Date(k);
        const todayDate = new Date(today);
        const diffDays = Math.floor((todayDate - keyDate) / 86400000);
        if (diffDays > keepDays) {
          delete data[k];
          changed = true;
        }
      });
      if (changed) localStorage.setItem(FOOD_STORAGE_KEY, JSON.stringify(data));
    }

    function renderList() {
      const foods = getFoods();
      const total = foods.reduce((sum, f) => sum + f.calories, 0);
      const bju = foods.reduce((acc, f) => ({
        protein: (acc.protein || 0) + (Number(f.protein) || 0),
        fat: (acc.fat || 0) + (Number(f.fat) || 0),
        carbs: (acc.carbs || 0) + (Number(f.carbs) || 0)
      }), { protein: 0, fat: 0, carbs: 0 });

      const goal = getGoal();
      updateHero(total, goal, bju);
      updateProgress(total, goal);
      tryConfettiOnGoalReached(total, goal);

      const drawerList = document.getElementById('todayListContent');
      const drawerActions = document.getElementById('drawerActions');
      if (foods.length === 0) {
        drawerList.innerHTML = '<div class="drawer-empty">–í—ã –µ—â—ë –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ —Å–µ–≥–æ–¥–Ω—è</div>';
        drawerActions.style.display = 'none';
        return;
      }

      drawerActions.style.display = 'block';
      drawerList.innerHTML = foods.map((food, index) => `
        <div class="food-item">
          <span class="food-name">${escapeHtml(food.name)}</span>
          <span class="food-item-right">
            <span class="food-calories">${food.calories} –∫–∫–∞–ª</span>
            <button type="button" class="btn-delete" data-index="${index}" aria-label="–£–¥–∞–ª–∏—Ç—å">üóë</button>
          </span>
        </div>
      `).join('');

      drawerList.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          haptic('impactOccurred', 'medium');
          const idx = parseInt(btn.dataset.index, 10);
          const newFoods = getFoods().filter((_, i) => i !== idx);
          saveFoods(newFoods);
          renderList();
        });
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // –ê–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫–∏
    const nameInput = document.getElementById('foodName');
    const caloriesInput = document.getElementById('foodCalories');
    const dropdown = document.getElementById('autocompleteDropdown');
    const MAX_SUGGESTIONS = 6;

    function getSuggestions(query) {
      const q = query.trim().toLowerCase();
      if (!q) return [];
      return FOOD_DATABASE
        .filter(f => f.name.toLowerCase().includes(q))
        .slice(0, MAX_SUGGESTIONS);
    }

    function showSuggestions(query) {
      const items = getSuggestions(query);
      if (items.length === 0) {
        dropdown.style.display = 'none';
        return;
      }
      dropdown.innerHTML = items.map(f => `
        <div class="autocomplete-item" data-name="${escapeHtml(f.name)}" data-cal="${f.calories}" data-protein="${f.protein || 0}" data-fat="${f.fat || 0}" data-carbs="${f.carbs || 0}">
          <span>${escapeHtml(f.name)}</span>
          <span class="cal">${f.calories} –∫–∫–∞–ª</span>
        </div>
      `).join('');
      dropdown.style.display = 'block';
      dropdown.querySelectorAll('.autocomplete-item').forEach(el => {
        el.addEventListener('click', () => {
          haptic('selectionChanged');
          nameInput.value = el.dataset.name;
          caloriesInput.value = el.dataset.cal;
          nameInput.dataset.bjuProtein = el.dataset.protein;
          nameInput.dataset.bjuFat = el.dataset.fat;
          nameInput.dataset.bjuCarbs = el.dataset.carbs;
          dropdown.style.display = 'none';
          caloriesInput.focus();
        });
      });
    }

    function hideSuggestions() {
      dropdown.style.display = 'none';
    }

    nameInput.addEventListener('input', () => showSuggestions(nameInput.value));
    nameInput.addEventListener('focus', () => showSuggestions(nameInput.value));
    nameInput.addEventListener('blur', () => setTimeout(hideSuggestions, 200));
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#foodNameGroup')) hideSuggestions();
    });

    // –ú–æ–¥–∞–ª–∫–∞ –∏ —Ü–µ–ª—å
    const goalModal = document.getElementById('goalModal');
    const goalForm = document.getElementById('goalForm');
    const goalInput = document.getElementById('goalInput');
    const btnSettingsGoal = document.getElementById('btnSettingsGoal');

    cleanupOldData();

    if (!getGoal()) {
      showGoalModal();
    }

    goalForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const val = parseInt(goalInput.value, 10);
      if (isNaN(val) || val < 500 || val > 10000) return;
      setGoal(val);
      hideGoalModal();
      renderList();
      haptic('impactOccurred');
    });

    btnSettingsGoal.addEventListener('click', () => {
      haptic('impactOccurred');
      goalInput.value = getGoal() || 2000;
      showGoalModal();
      goalInput.focus();
    });

    document.getElementById('btnThemeLight').addEventListener('click', () => {
      haptic('selectionChanged');
      setTheme('light');
    });

    document.getElementById('btnThemeDark').addEventListener('click', () => {
      haptic('selectionChanged');
      setTheme('dark');
    });

    document.getElementById('btnTodayList').addEventListener('click', () => {
      haptic('impactOccurred');
      document.getElementById('todayListOverlay').classList.add('open');
    });

    document.getElementById('todayListOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'todayListOverlay') {
        document.getElementById('todayListOverlay').classList.remove('open');
      }
    });

    const confirmClearModal = document.getElementById('confirmClearModal');
    const confirmClearCancel = document.getElementById('confirmClearCancel');
    const confirmClearOk = document.getElementById('confirmClearOk');

    document.getElementById('btnClearList').addEventListener('click', () => {
      haptic('impactOccurred');
      document.getElementById('todayListOverlay').classList.remove('open');
      setTimeout(() => {
        confirmClearModal.style.display = 'flex';
      }, 350);
    });

    confirmClearCancel.addEventListener('click', () => {
      haptic('selectionChanged');
      confirmClearModal.style.display = 'none';
    });

    confirmClearOk.addEventListener('click', () => {
      haptic('impactOccurred', 'medium');
      saveFoods([]);
      renderList();
      confirmClearModal.style.display = 'none';
    });

    confirmClearModal.addEventListener('click', (e) => {
      if (e.target === confirmClearModal) {
        confirmClearModal.style.display = 'none';
      }
    });

    document.getElementById('btnHistory').addEventListener('click', () => {
      haptic('impactOccurred');
      const goal = getGoal();
      const list = document.getElementById('historyList');
      const days = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const key = getDateKey(d);
        const foods = getFoods(key);
        const total = foods.reduce((s, f) => s + f.calories, 0);
        const fmt = d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: 'numeric' });
        const hasGoal = goal && goal > 0;
        days.push({ key, fmt, total, ok: hasGoal ? total <= goal : null });
      }
      list.innerHTML = days.map(({ fmt, total, ok }) => {
        const status = ok === null ? '‚Äî' : (ok ? '‚úì' : '‚úó');
        const statusClass = ok === null ? '' : (ok ? 'ok' : 'fail');
        return `
        <div class="history-item">
          <span class="history-date">${fmt}</span>
          <span>
            <span class="history-cal">${total} –∫–∫–∞–ª</span>
            <span class="history-status ${statusClass}">${status}</span>
          </span>
        </div>`;
      }).join('');
      document.getElementById('historyModal').style.display = 'flex';
    });

    document.getElementById('historyModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay') || e.target.classList.contains('history-modal')) {
        document.getElementById('historyModal').style.display = 'none';
      }
    });

    document.getElementById('foodForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = nameInput.value.trim();
      const calories = parseInt(caloriesInput.value, 10);

      if (!name || isNaN(calories) || calories < 0) return;

      const bju = getBJUFromDb(name, calories);

      const foods = getFoods();
      foods.push({ name, calories, protein: bju.protein, fat: bju.fat, carbs: bju.carbs });
      saveFoods(foods);
      renderList();

      nameInput.value = '';
      caloriesInput.value = '';
      delete nameInput.dataset.bjuProtein;
      delete nameInput.dataset.bjuFat;
      delete nameInput.dataset.bjuCarbs;
      document.activeElement.blur();

      haptic('impactOccurred');
    });

    renderList();
  </script>
</body>
</html>
